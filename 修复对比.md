# ğŸ”„ ä»£ç ä¿®å¤å‰åå¯¹æ¯”

## ğŸ”´ é—®é¢˜1ï¼šSSHæ¡æ‰‹é€šé“é€»è¾‘

### ä¿®å¤å‰
```python
# ç¬¬1æ­¥ï¼šè®¤è¯
auth_success, transport = self._verify_rsa_auth(client_sock)

# _verify_rsa_auth() å†…éƒ¨ï¼š
channel = transport.accept(15)  # âŒ é”™è¯¯ï¼šç­‰å¾…æ¡æ‰‹é€šé“
if server.auth_success and transport.is_authenticated():
    return True, transport  # âŒ ä½†å…¶å®é€šé“è¿˜æ²¡åˆ°è¾¾

# ç¬¬2æ­¥ï¼šä¸»å‡½æ•°ä¸­
client_channel = transport.accept(20)  # âŒ é”™è¯¯ï¼šç­‰å¾…ç¬¬äºŒä¸ªé€šé“ï¼ˆä¸å­˜åœ¨ï¼‰
if not client_channel:
    logger.warning(f"âœ— æœªå»ºç«‹é€šé“")
    return  # âŒ ç›´æ¥é€€å‡ºï¼Œæ–­å¼€è¿æ¥
```

**é—®é¢˜æµç¨‹**ï¼š
```
SSHæ¡æ‰‹
  â”œâ”€ å¯†é’¥äº¤æ¢
  â”œâ”€ ç”¨æˆ·è®¤è¯ âœ“ æˆåŠŸ
  â””â”€ ç¬¬1ä¸ª accept() â† è·å–åˆ°çš„æ˜¯æ¡æ‰‹è¿‡ç¨‹ä¸­çš„"è™šæ‹Ÿé€šé“"ï¼Ÿ
                      ä¸å¯¹ï¼Œå…¶å®æ ¹æœ¬æ²¡æœ‰é€šé“
                      
ä»£ç†å†æ¬¡è°ƒç”¨ accept(20)
  â”œâ”€ ç­‰å¾…å®¢æˆ·ç«¯çš„çœŸå®é€šé“è¯·æ±‚...
  â”œâ”€ 20ç§’è¿‡å»äº†...
  â””â”€ ä»æœªæ”¶åˆ°é€šé“ âœ—
  
å®¢æˆ·ç«¯ï¼šæˆ‘å·²ç»è®¤è¯äº†ï¼Œä¸ºä»€ä¹ˆè¿˜åœ¨ç­‰ï¼Ÿ
  â””â”€ ä¸»åŠ¨æ–­å¼€ (code 11)

ä»£ç†ï¼šå®¢æˆ·ç«¯æ–­å¼€äº†ï¼Œè®°å½•"æœªå»ºç«‹é€šé“"
```

### ä¿®å¤å
```python
# _verify_rsa_auth() å†…éƒ¨ - æ”¹ä¸ºè½®è¯¢ç­‰å¾…è®¤è¯
transport.start_server(server=server)  # å¯åŠ¨ä½†ä¸ç­‰å¾…

# âœ“ è½®è¯¢è®¤è¯çŠ¶æ€ï¼Œè€Œéé˜»å¡ç­‰å¾…é€šé“
for attempt in range(SSH_HANDSHAKE_TIMEOUT * 10):
    if transport.is_authenticated():  # æ£€æŸ¥è®¤è¯æ ‡å¿—
        logger.info(f"âœ“ è®¤è¯é€šè¿‡")
        return True, transport  # âœ“ ç«‹å³è¿”å›
    
    if not transport.is_active():
        return False, transport
    
    time.sleep(0.1)

# ä¸»å‡½æ•°ä¸­ - æ”¹ä¸ºå¾ªç¯å¤„ç†å¤šä¸ªé€šé“
logger.info(f"Transportå·²å»ºç«‹ï¼Œå¼€å§‹ç›‘å¬é€šé“...")

while True:
    client_channel = transport.accept(timeout=CHANNEL_ACCEPT_TIMEOUT)
    
    if client_channel is None:
        logger.debug("[è¶…æ—¶] ç»§ç»­ç­‰å¾…...")
        continue  # âœ“ è¶…æ—¶ä¸é€€å‡ºï¼Œç»§ç»­ç­‰å¾…
    
    # âœ“ ä¸ºæ¯ä¸ªé€šé“è¿æ¥çœŸå®SSHå¹¶è½¬å‘
    server_socket = socket.socket()
    server_socket.connect((REAL_SSH_HOST, REAL_SSH_PORT))
    self.forward_traffic(client_channel, server_socket)
    
    # âœ“ ç»§ç»­ç­‰å¾…ä¸‹ä¸€ä¸ªé€šé“
```

**ä¿®å¤æµç¨‹**ï¼š
```
SSHæ¡æ‰‹
  â”œâ”€ å¯†é’¥äº¤æ¢
  â”œâ”€ ç”¨æˆ·è®¤è¯ âœ“
  â””â”€ è½®è¯¢æ£€æŸ¥ is_authenticated() âœ“ ç«‹å³è¿”å›
  
è¿›å…¥é€šé“å¾ªç¯
  â”œâ”€ ç­‰å¾…å®¢æˆ·ç«¯çš„é€šé“è¯·æ±‚...
  â”œâ”€ å®¢æˆ·ç«¯å»ºç«‹é€šé“ âœ“
  â”œâ”€ è¿æ¥çœŸå®SSH âœ“
  â”œâ”€ è½¬å‘æµé‡ âœ“
  â””â”€ ç»§ç»­ç­‰å¾…ä¸‹ä¸€ä¸ªé€šé“ï¼ˆå¯ä»¥æ‰§è¡Œå¤šä¸ªå‘½ä»¤ï¼‰
```

---

## ğŸ”´ é—®é¢˜2ï¼šè¶…æ—¶é…ç½®åˆ†æ•£

### ä¿®å¤å‰
```python
# è¡Œ152-153
transport.banner_timeout = 10
transport.channel_timeout = 15

# è¡Œ191
channel = transport.accept(15)

# è¡Œ223
client_channel = transport.accept(20)

# è¡Œ213
client_sock.settimeout(10)
```

**é—®é¢˜**ï¼šè¶…æ—¶å€¼åˆ†æ•£åœ¨ä»£ç å„å¤„ï¼Œä¸ä¸€è‡´ï¼Œéš¾ä»¥è°ƒæ•´

### ä¿®å¤å
```python
# è¡Œ16-19 - ç»Ÿä¸€å®šä¹‰
SOCKET_TIMEOUT = 10              # Socketæ“ä½œè¶…æ—¶
SSH_HANDSHAKE_TIMEOUT = 5        # SSHæ¡æ‰‹è¶…æ—¶
CHANNEL_ACCEPT_TIMEOUT = 10      # é€šé“ç­‰å¾…è¶…æ—¶

# ä½¿ç”¨å¸¸é‡
transport.banner_timeout = SSH_HANDSHAKE_TIMEOUT
transport.channel_timeout = SSH_HANDSHAKE_TIMEOUT
client_sock.settimeout(SOCKET_TIMEOUT)
client_channel = transport.accept(timeout=CHANNEL_ACCEPT_TIMEOUT)
```

**æ”¹è¿›**ï¼š
- âœ“ æ‰€æœ‰è¶…æ—¶åœ¨ä¸€ä¸ªåœ°æ–¹å®šä¹‰
- âœ“ è¶…æ—¶å€¼æ›´åˆç†ï¼ˆæ¡æ‰‹5ç§’vsåŸæ¥çš„10-20ç§’ï¼‰
- âœ“ ä¾¿äºå…¨å±€è°ƒæ•´

---

## ğŸ”´ é—®é¢˜3ï¼šèµ„æºæ£€æŸ¥ä¸å½“

### ä¿®å¤å‰
```python
# âŒ è®¿é—®ç§æœ‰å±æ€§ _closedï¼ˆä¸æ¨èï¼‰
if server_socket and not server_socket._closed:
    server_socket.close()

# âŒ åæ‰å¼‚å¸¸ï¼Œæ— æ—¥å¿—
except:
    pass
```

### ä¿®å¤å
```python
# âœ“ ä½¿ç”¨å…¬å¼€API fileno()
if server_socket and server_socket.fileno() != -1:
    server_socket.close()
    logger.debug("æœåŠ¡å™¨Socketå·²å…³é—­")

# âœ“ æ•è·å¼‚å¸¸å¹¶è®°å½•
except Exception as e:
    logger.error(f"å…³é—­å¤±è´¥ï¼š{type(e).__name__}: {e}")
```

**æ”¹è¿›**ï¼š
- âœ“ `fileno() == -1` æ˜¯æ£€æŸ¥socketå…³é—­çš„æ ‡å‡†åšæ³•
- âœ“ å¼‚å¸¸è¢«è®°å½•ï¼Œä¾¿äºè°ƒè¯•

---

## ğŸ”´ é—®é¢˜4ï¼šå¼‚å¸¸å¤„ç†ä¸å®Œå–„

### ä¿®å¤å‰
```python
try:
    # æŸäº›ä»£ç 
    pass
except Exception as e:
    logger.error(f"é”™è¯¯ï¼š{e}")  # âŒ ä¸¢å¤±å¼‚å¸¸ç±»å‹
    
except:  # âŒ è£¸å¼‚å¸¸æ•è·
    pass  # âŒ ä»€ä¹ˆéƒ½ä¸åš
```

### ä¿®å¤å
```python
try:
    # æŸäº›ä»£ç 
    pass
except SSHException as e:
    logger.error(f"SSHé”™è¯¯ï¼š{e}")  # âœ“ åŒºåˆ†å¼‚å¸¸ç±»å‹
except ConnectionRefusedError:
    logger.error(f"è¿æ¥æ‹’ç»")      # âœ“ å…·ä½“å¤„ç†
except Exception as e:
    logger.error(f"å¼‚å¸¸ï¼š{type(e).__name__}: {e}")  # âœ“ è®°å½•è¯¦ç»†ä¿¡æ¯
```

**æ”¹è¿›**ï¼š
- âœ“ å¼‚å¸¸ç±»å‹è®°å½•ä¸º `type(e).__name__`
- âœ“ ç‰¹å®šå¼‚å¸¸å•ç‹¬å¤„ç†
- âœ“ æ²¡æœ‰ `except: pass` åæ‰é”™è¯¯

---

## ğŸ”´ é—®é¢˜5ï¼šæ—¥å¿—ä¿¡æ¯ä¸è¶³

### ä¿®å¤å‰
```python
logger.info("[é€šé“] ç­‰å¾…å®¢æˆ·ç«¯å»ºç«‹SSHé€šé“...")
client_channel = transport.accept(20)

if not client_channel:
    logger.warning(f"[é€šé“] âœ— å®¢æˆ·ç«¯æœªå»ºç«‹é€šé“")
    return  # æ²¡æœ‰è¯´æ˜åŸå› 
```

### ä¿®å¤å
```python
logger.debug("[é€šé“] ç­‰å¾…å®¢æˆ·ç«¯å»ºç«‹æ–°çš„SSHé€šé“...")
client_channel = transport.accept(timeout=CHANNEL_ACCEPT_TIMEOUT)

if client_channel is None:
    logger.debug("[é€šé“] â„¹ï¸  é€šé“æ¥æ”¶è¶…æ—¶ï¼Œç»§ç»­ç­‰å¾…...")  # âœ“ è¯´æ˜è¿™ä¸æ˜¯é”™è¯¯
    continue

logger.info(f"[é€šé“] âœ“ æ¥æ”¶åˆ°æ–°é€šé“ï¼š{client_channel.get_name()}(ID:{client_channel.get_id()})")
# âœ“ è®°å½•é€šé“çš„åå­—å’ŒIDï¼Œä¾¿äºè¿½è¸ª
```

**æ”¹è¿›**ï¼š
- âœ“ è¶…æ—¶æ˜¯æ­£å¸¸æƒ…å†µï¼Œæ”¹ä¸º debug çº§åˆ«å¹¶ç»§ç»­
- âœ“ æˆåŠŸæ—¶è®°å½•é€šé“è¯¦ç»†ä¿¡æ¯
- âœ“ æ—¥å¿—æ¶ˆæ¯æ›´æ¸…æ¥š

---

## ğŸ“Š æ•´ä½“å¯¹æ¯”

| æ–¹é¢ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **é€šé“å¤„ç†** | å•æ¬¡ï¼Œè¶…æ—¶è¿”å› | å¾ªç¯å¤„ç†ï¼Œè¶…æ—¶ç»§ç»­ |
| **è¶…æ—¶é…ç½®** | åˆ†æ•£ã€ä¸ä¸€è‡´ | ç»Ÿä¸€ã€å¯é…ç½® |
| **è®¤è¯æ£€æŸ¥** | é˜»å¡ç­‰å¾…é€šé“ | è½®è¯¢æ£€æŸ¥æ ‡å¿— |
| **å¼‚å¸¸å¤„ç†** | `except: pass` | æ•è·ã€åˆ†ç±»ã€è®°å½• |
| **èµ„æºæ£€æŸ¥** | è®¿é—®ç§æœ‰å±æ€§ | ä½¿ç”¨å…¬å¼€API |
| **æ—¥å¿—è´¨é‡** | ç®€å•ã€ä¿¡æ¯ä¸è¶³ | è¯¦ç»†ã€å¼‚å¸¸ç±»å‹æ¸…æ™° |
| **ä»£ç æ³¨é‡Š** | æ—  | æ·»åŠ äº†ä¿®å¤è¯´æ˜ |

---

## âœ… éªŒè¯

### ä¿®å¤å‰çš„æ—¥å¿—ï¼ˆé—®é¢˜ç°è±¡ï¼‰
```
[è®¤è¯] âœ“ ç”¨æˆ· 'root' è®¤è¯é€šè¿‡ï¼ŒTransportå·²å»ºç«‹
[é€šé“] ç­‰å¾…å®¢æˆ·ç«¯å»ºç«‹SSHé€šé“...
Disconnect (code 11): disconnected by user
[é€šé“] âœ— å®¢æˆ·ç«¯ 114.251.196.99 æœªå»ºç«‹é€šé“
```

### ä¿®å¤åçš„é¢„æœŸæ—¥å¿—ï¼ˆæ­£å¸¸æµç¨‹ï¼‰
```
[è®¤è¯] ç­‰å¾…SSHæ¡æ‰‹å’Œè®¤è¯å®Œæˆ...
âœ“ ç”¨æˆ· 'root' è®¤è¯é€šè¿‡ï¼ŒTransportå·²å»ºç«‹
âœ“ Transportå·²å»ºç«‹ï¼Œå¼€å§‹ç›‘å¬å®¢æˆ·ç«¯é€šé“...
[é€šé“] ç­‰å¾…å®¢æˆ·ç«¯å»ºç«‹æ–°çš„SSHé€šé“...
[é€šé“] âœ“ æ¥æ”¶åˆ°æ–°é€šé“ï¼šsession(ID:0)
[è¿æ¥] è¿æ¥çœŸå®SSHæœåŠ¡ï¼šlocalhost:2222...
[è¿æ¥] âœ“ å·²è¿æ¥åˆ°çœŸå®SSHæœåŠ¡
[è½¬å‘] å¯åŠ¨è¯¥é€šé“çš„æµé‡è½¬å‘...
â†’ å®¢æˆ·ç«¯â†’æœåŠ¡å™¨è½¬å‘ 50 å­—èŠ‚
â† æœåŠ¡å™¨â†’å®¢æˆ·ç«¯è½¬å‘ 100 å­—èŠ‚
...ï¼ˆå‘½ä»¤æ‰§è¡Œå’Œè¾“å‡ºè½¬å‘ï¼‰
âœ“ è½¬å‘å®Œæˆï¼Œè¿æ¥å…³é—­
[æ¸…ç†] âœ“ Transportå·²å…³é—­
[æ¸…ç†] âœ“ å®¢æˆ·ç«¯Socketå·²å…³é—­
[æ–­å¼€] è¿æ¥å…³é—­ï¼š114.251.196.99:57860
```

